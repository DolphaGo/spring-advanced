- [빈 후처리기](#빈-후처리기)
  - [빈 후처리기 - 소개](#빈-후처리기---소개)
  - [빈 후처리기 - 예제 코드 1](#빈-후처리기---예제-코드-1)
  - [빈 후처리기 - 예제 코드 2](#빈-후처리기---예제-코드-2)
  - [빈 후처리기 - 적용](#빈-후처리기---적용)
  - [빈 후처리기 - 정리](#빈-후처리기---정리)
  - [스프링이 제공하는 빈 후처리기 1](#스프링이-제공하는-빈-후처리기-1)
  - [스프링이 제공하는 빈 후처리기 2](#스프링이-제공하는-빈-후처리기-2)
  - [하나의 프록시, 여러 Advisor 적용](#하나의-프록시-여러-advisor-적용)
  - [정리](#정리)

---

# 빈 후처리기

## 빈 후처리기 - 소개

![](/images/2022-05-06-02-42-54.png)

- `@Bean`이나 컴포넌트 스캔으로 스프링 빈을 등록하면, 스프링은 대상 객체를 생성하고, 스프링 컨테이너 내부의 빈 저장소에 등록한다.
- 그리고 이후에는 스프링 컨테이너를 통해 등록한 스프링 빈을 조회해서 사용하면 된다.

**빈 후처리기 - BeanPostProcessor**

- 스프링이 빈 저장소에 등록할 목적으로 생성한 객체를, 빈 저장소에 등록하기 **직전에** 조작하고 싶다면, 빈 후처리기를 이용하면 된다.
- 빈 포스트 프로세서(`BeanPostProcessor`) 는 번역하면 빈 후처리기인데, 이름 그대로 빈을 생성한 후에 무언가를 처리하는 용도로 사용한다.

**빈 후처리기 기능**
- 빈 후처리기 기능은 막강하다.
- 객체를 조작할 수도 있고, 완전히 다른 객체로 바꿔치기 하는 것도 가능하다.

**빈 후처리기 과정**

![](/images/2022-05-06-02-44-57.png)

> 빈 등록 과정을 빈 후처리기와 함께 살펴보자.

1. 생성: 스프링 빈 대상이 되는 객체를 생성한다.(`@Bean`, 컴포넌트 스캔 모두 포함)
2. 전달: 생성된 객체를 빈 저장소에 등록하기 직전에 빈 후처리기에 전달한다.
3. **후 처리 작업**: 빈 후처리기는 전달된 스프링 빈 객체를 조작하거나, 다른 객체로 바꿔치기 할 수 있다.
4. 등록: 빈 후처리기는 빈을 반환한다. 전달된 빈을 그대로 반환하면 해당 빈이 등록되고, 바꿔치기하면 다른 객체가 빈 저장소에 등록된다.

**다른 객체로 바꿔치는 빈 후처리기**

![](/images/2022-05-06-02-45-12.png)

## 빈 후처리기 - 예제 코드 1

- 일반적인 스프링 빈 등록과정
  - 빈 후처리기를 학습하기 전 먼저 일반적인 스프링 빈 등록 과정을 코드로 작성해보자.

![](/images/2022-05-06-02-49-08.png)

```java
public class BasicTest {

    @Test
    void basicConfig() {
        final ApplicationContext applicationContext = new AnnotationConfigApplicationContext(BasicConfig.class);

        // A는 빈으로 등록된다.
        final A a = applicationContext.getBean("beanA", A.class);
        a.helloA();

        // B는 빈으로 등록되지 않는다.
        assertThrows(NoSuchBeanDefinitionException.class, () -> applicationContext.getBean(B.class));
    }

    @Slf4j
    @Configuration
    static class BasicConfig {
        @Bean(name = "beanA")
        public A a() {
            return new A();
        }
    }

    @Slf4j
    static class A {
        public void helloA() {
            log.info("hello A");
        }
    }

    @Slf4j
    static class B {
        public void helloB() {
            log.info("hello B");
        }
    }
}
```

- `new AnnotationConfigApplicationContext(BasicConfig.class)`
  - 스프링 컨테이너를 생성하면서, `BasicConfig.class` 를 넘겨주었다.
  - `BasicConfig.class` 설정파일은 스프링 빈으로 등록된다.
- `beanA` 라는 이름으로 A 객체를 스프링 빈으로 등록했다.
- `applicationContext.getBean(B.class)`
  - B 타입의 객체는 스프링 빈으로 등록한 적이 없기 때문에 스프링 컨테이너에서 찾을 수 없다.


## 빈 후처리기 - 예제 코드 2

> **빈 후처리기 적용**

- 이번에는 빈 후처리기를 통해서 A 객체를 B 객체로 바꿔치기 해보자.

![](/images/2022-05-06-02-58-37.png)

> BeanPostProcessor 인터페이스 - 스프링 제공

```java
package org.springframework.beans.factory.config;

import org.springframework.beans.BeansException;
import org.springframework.lang.Nullable;

public interface BeanPostProcessor {
    @Nullable
    default Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {
        return bean;
    }

    @Nullable
    default Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {
        return bean;
    }
}
```

- 빈 후처리기는 사용하려면, `BeanPostProcessor` 인터페이스를 구현하고, 스프링 빈으로 등록하면 된다.
- `postProcessBeforeInitialization` : 객체 생성 이후에 `@PostConstruct` 같은 초기화가 **발생되기 전에** 호출되는 포스트 프로세서이다.
- `postProcessAfterInitialization`: 객체 생성 이후에 `@PostConstruct` 같은 초기화가 **발생한 다음에** 호출되는 포스트 프로세서이다.

> Test

```java
public class BeanPostProcessorTest {

    @Test
    void basicConfig() {
        final ApplicationContext applicationContext = new AnnotationConfigApplicationContext(BeanPostProcessorConfig.class);

        // 이름이 beanA지만, A가 아니라 postProcessor에 의해 B가 빈으로 등록된다.
        final B b = applicationContext.getBean("beanA", B.class);
        b.helloB();

        // A는 빈으로 등록되지 않는다.
        assertThrows(NoSuchBeanDefinitionException.class, () -> applicationContext.getBean(A.class));
    }

    @Slf4j
    @Configuration
    static class BeanPostProcessorConfig {
        @Bean(name = "beanA")
        public A a() {
            return new A();
        }

        @Bean
        public AToBPostProcessor helloPostProcessor() { // BeanPostProcessor가 먼저 우선권이 있다고 이해하면 편하다.
            return new AToBPostProcessor();
        }
    }

    @Slf4j
    static class A {
        public void helloA() {
            log.info("hello A");
        }
    }

    @Slf4j
    static class B {
        public void helloB() {
            log.info("hello B");
        }
    }

    @Slf4j
    static class AToBPostProcessor implements BeanPostProcessor {

        @Nullable
        public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {
            log.info("beanName={}, bean={}", beanName, bean);
            if (bean instanceof A) {
                return new B();
            }
            return bean;
        }
    }
}
```

**AToBPostProcessor**

- 빈 후처리기이다.
- 인터페이스인 `BeanPostProcessor`를 구현하고, **스프링 빈으로 등록하면, 스프링 컨테이너가 빈 후처리기로 인식하고 동작한다.**
- 이 빈 후처리기는 A 객체를 새로운 B 객체로 바꿔치기 한다.
- 파라미터로 넘어오는 bean 객체가 A의 인스턴이스면 새로운 B 객체를 생성해서 반환한다.
- 여기서 A대신에 반환된 값인 B가 스프링 컨테이너에 등록된다.
- 다음 실행 결과를 보면, `beanName=beanA`, `bean=A` 객체의 인스턴스가 빈 후처리기에 넘어온 것을 확인할 수 있다.

> 실행 결과

```log
03:06:50.665 [main] INFO hello.proxy.postprocessor.BeanPostProcessorTest$AToBPostProcessor - beanName=beanA, bean=hello.proxy.postprocessor.BeanPostProcessorTest$A@1b73be9f
03:06:50.684 [main] INFO hello.proxy.postprocessor.BeanPostProcessorTest$B - hello B
```

**`applicationContext.getBean("beanA", B.class)`**
- 실행 결과를 보면 최종적으로 `beanA`라는 스프링 빈 이름에 `A` 객체 대신에 `B` 객체가 등록된 것을 확인할 수 있다.
- `A`는 스프링 빈으로 등록조차 되지 않는다.

> **정리**

- 빈 후처리기는 빈을 조작하고, 변경할 수 있는 후킹 포인트이다.
- 여기서 빈 객체를 조작하거나, 심지어 다른 객체로 바꾸어 버릴 수 있을 정도로 막강하다.
- 여기서 조작이라는 것은 해당 객체의 특정 메서드를 호출하는 것을 뜻한다.
- 일반적으로 스프링 컨테이너가 등록하는, 특히 컴포넌트 스캔의 대상이 되는 빈들은 중간에 조작할 방법이 없는데, **빈 후처리기를 이용하면 개발자가 등록하는 모든 빈을 중간에 조작할 수 있다.**
- **이 말은 빈 객체를 프록시로 교체하는 것도 가능**하다는 뜻이다.

> ***참고 - `@PostConstruct` 의 비밀***

- `@PostConstruct`는 스프링 빈 생성 이후에 빈을 초기화하는 역할을 한다.
- 그런데 생각해보면 빈의 초기화라는 것이 단순히 `@PostConstruct` 애노테이션이 붙은 초기화 메서드를 한번 호출만 하면 된다.
- 쉽게 이야기해서 생성된 빈을 한 번 조작하는 것이다.
- 따라서 빈을 조작하는 행위를 하는 적절한 빈 후처리기가 있으면 될 것 같다.
- 스프링은 `CommonAnnotationBeanPostProcessor` 라는 빈 후처리기를 자동으로 등록하는데, 여기에서 `@PostConstruct` 애노테이션이 붙은 메서드를 호출한다.
![](/images/2022-05-06-03-17-29.png)

- 따라서 스프링 스스로도 스프링 내부의 기능을 확장하기 위해 빈 후처리기를 사용한다.

## 빈 후처리기 - 적용

- 빈 후처리기를 사용해서, 실제 객체 대신 프록시를 스프링 빈으로 등록해보자.
- 이렇게하면 수동으로 등록하는 빈은 물론이고, 컴포넌트 스캔을 사용하는 빈까지 모두 프록시를 적용할 수 있다.
- 더 나아가서 설정 파일에 있는 수 많은 프록시 생성 코드도 한 번에 제거할 수 있다.

![](/images/2022-05-06-03-19-14.png)

> BeanPostProcessor 구현

- 특정 패키지로 시작하는 Bean만 프록시 적용대상으로 한다.

```java
@Slf4j
public class PackageLogTracePostProcessor implements BeanPostProcessor {

    private final String basePackage;
    private final Advisor advisor;

    public PackageLogTracePostProcessor(final String basePackage, final Advisor advisor) {
        this.basePackage = basePackage;
        this.advisor = advisor;
    }

    @Override
    public Object postProcessAfterInitialization(final Object bean, final String beanName) throws BeansException {
        log.info("param beanName={} bean={}", beanName, bean.getClass());

        // 프록시 적용 대상 여부 체크.
        // 프록시 적용 대상이 아니면 원본을 그대로 진행
        final String packageName = bean.getClass().getPackageName();
        if (!packageName.startsWith(basePackage)) {
            return bean;
        }

        // 프록시 대상이면 프록시를 만들어서 반환
        final ProxyFactory proxyFactory = new ProxyFactory(bean);
        proxyFactory.addAdvisor(advisor);
        final Object proxy = proxyFactory.getProxy();
        log.info("create proxy: target={} proxy={}", bean.getClass(), proxy.getClass());
        return proxy; // 이 프록시 객체가 스프링 빈에 등록된다.
    }
}
```

> Config 등록

```java
@Slf4j
@Configuration
@Import({ AppV1Config.class, AppV2Config.class })
public class BeanPostProcessorConfig {

    @Bean
    public PackageLogTracePostProcessor logTracePostProcessor(LogTrace logTrace){
        return new PackageLogTracePostProcessor("hello.proxy.app", getAdvisor(logTrace));
    }

    private Advisor getAdvisor(final LogTrace logTrace) {
        // pointcut
        final NameMatchMethodPointcut pointcut = new NameMatchMethodPointcut();
        pointcut.setMappedNames("request*", "order*", "save*");

        // advice
        final LogTraceAdvice advice = new LogTraceAdvice(logTrace);

        return new DefaultPointcutAdvisor(pointcut, advice);
    }
}
```

- V1, V2도 같이 Bean으로 등록한다. (V3은 컴포넌트 스캔의 대상이므로 필요 없다.)

> Applicaiton main

```java
@Import(BeanPostProcessorConfig.class)
@SpringBootApplication(scanBasePackages = "hello.proxy.app") //주의
public class ProxyApplication {

	public static void main(String[] args) {
		SpringApplication.run(ProxyApplication.class, args);
	}

	@Bean
	public LogTrace logTrace(){
		return new ThreadLocalLogTrace();
	}
}
```

> 실행

- v1, v2, v3 모두 실행해본다.

```
http://localhost:8080/v1/request?itemId=DolphaGo
http://localhost:8080/v2/request?itemId=DolphaGo
http://localhost:8080/v3/request?itemId=DolphaGo
```

> 결과

```log
2022-05-06 03:32:14.082  INFO 91669 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'hello.proxy.config.v4_postprocessor.BeanPostProcessorConfig' of type [hello.proxy.config.v4_postprocessor.BeanPostProcessorConfig$$EnhancerBySpringCGLIB$$6a53ed23] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2022-05-06 03:32:14.085  INFO 91669 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'proxyApplication' of type [hello.proxy.ProxyApplication$$EnhancerBySpringCGLIB$$f5ffe2ea] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2022-05-06 03:32:14.091  INFO 91669 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'logTrace' of type [hello.proxy.trace.logtrace.ThreadLocalLogTrace] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2022-05-06 03:32:14.101  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.web.servlet.ServletWebServerFactoryConfiguration$EmbeddedTomcat bean=class org.springframework.boot.autoconfigure.web.servlet.ServletWebServerFactoryConfiguration$EmbeddedTomcat
2022-05-06 03:32:14.125  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.websocket.servlet.WebSocketServletAutoConfiguration$TomcatWebSocketConfiguration bean=class org.springframework.boot.autoconfigure.websocket.servlet.WebSocketServletAutoConfiguration$TomcatWebSocketConfiguration
2022-05-06 03:32:14.125  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=websocketServletWebServerCustomizer bean=class org.springframework.boot.autoconfigure.websocket.servlet.TomcatWebSocketServletWebServerCustomizer
2022-05-06 03:32:14.127  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.web.servlet.ServletWebServerFactoryAutoConfiguration bean=class org.springframework.boot.autoconfigure.web.servlet.ServletWebServerFactoryAutoConfiguration
2022-05-06 03:32:14.132  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.context.properties.BoundConfigurationProperties bean=class org.springframework.boot.context.properties.BoundConfigurationProperties
2022-05-06 03:32:14.137  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=server-org.springframework.boot.autoconfigure.web.ServerProperties bean=class org.springframework.boot.autoconfigure.web.ServerProperties
2022-05-06 03:32:14.137  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=servletWebServerFactoryCustomizer bean=class org.springframework.boot.autoconfigure.web.servlet.ServletWebServerFactoryCustomizer
2022-05-06 03:32:14.138  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=tomcatServletWebServerFactoryCustomizer bean=class org.springframework.boot.autoconfigure.web.servlet.TomcatServletWebServerFactoryCustomizer
2022-05-06 03:32:14.138  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.web.embedded.EmbeddedWebServerFactoryCustomizerAutoConfiguration$TomcatWebServerFactoryCustomizerConfiguration bean=class org.springframework.boot.autoconfigure.web.embedded.EmbeddedWebServerFactoryCustomizerAutoConfiguration$TomcatWebServerFactoryCustomizerConfiguration
2022-05-06 03:32:14.139  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=tomcatWebServerFactoryCustomizer bean=class org.springframework.boot.autoconfigure.web.embedded.TomcatWebServerFactoryCustomizer
2022-05-06 03:32:14.141  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.web.servlet.HttpEncodingAutoConfiguration bean=class org.springframework.boot.autoconfigure.web.servlet.HttpEncodingAutoConfiguration
2022-05-06 03:32:14.141  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=localeCharsetMappingsCustomizer bean=class org.springframework.boot.autoconfigure.web.servlet.HttpEncodingAutoConfiguration$LocaleCharsetMappingsCustomizer
2022-05-06 03:32:14.154  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.web.servlet.error.ErrorMvcAutoConfiguration bean=class org.springframework.boot.autoconfigure.web.servlet.error.ErrorMvcAutoConfiguration
2022-05-06 03:32:14.155  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.web.servlet.DispatcherServletAutoConfiguration$DispatcherServletRegistrationConfiguration bean=class org.springframework.boot.autoconfigure.web.servlet.DispatcherServletAutoConfiguration$DispatcherServletRegistrationConfiguration
2022-05-06 03:32:14.155  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.web.servlet.DispatcherServletAutoConfiguration$DispatcherServletConfiguration bean=class org.springframework.boot.autoconfigure.web.servlet.DispatcherServletAutoConfiguration$DispatcherServletConfiguration
2022-05-06 03:32:14.160  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=spring.mvc-org.springframework.boot.autoconfigure.web.servlet.WebMvcProperties bean=class org.springframework.boot.autoconfigure.web.servlet.WebMvcProperties
2022-05-06 03:32:14.166  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=dispatcherServlet bean=class org.springframework.web.servlet.DispatcherServlet
2022-05-06 03:32:14.169  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=spring.servlet.multipart-org.springframework.boot.autoconfigure.web.servlet.MultipartProperties bean=class org.springframework.boot.autoconfigure.web.servlet.MultipartProperties
2022-05-06 03:32:14.169  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.web.servlet.MultipartAutoConfiguration bean=class org.springframework.boot.autoconfigure.web.servlet.MultipartAutoConfiguration
2022-05-06 03:32:14.170  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=multipartConfigElement bean=class javax.servlet.MultipartConfigElement
2022-05-06 03:32:14.171  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=dispatcherServletRegistration bean=class org.springframework.boot.autoconfigure.web.servlet.DispatcherServletRegistrationBean
2022-05-06 03:32:14.172  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=errorPageCustomizer bean=class org.springframework.boot.autoconfigure.web.servlet.error.ErrorMvcAutoConfiguration$ErrorPageCustomizer
2022-05-06 03:32:14.172  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=tomcatServletWebServerFactory bean=class org.springframework.boot.web.embedded.tomcat.TomcatServletWebServerFactory
2022-05-06 03:32:14.230  INFO 91669 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 8080 (http)
2022-05-06 03:32:14.235  INFO 91669 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]
2022-05-06 03:32:14.235  INFO 91669 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat/9.0.53]
2022-05-06 03:32:14.271  INFO 91669 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext
2022-05-06 03:32:14.271  INFO 91669 --- [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 544 ms
2022-05-06 03:32:14.273  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=requestContextFilter bean=class org.springframework.boot.web.servlet.filter.OrderedRequestContextFilter
2022-05-06 03:32:14.274  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration bean=class org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration
2022-05-06 03:32:14.275  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=formContentFilter bean=class org.springframework.boot.web.servlet.filter.OrderedFormContentFilter
2022-05-06 03:32:14.276  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=characterEncodingFilter bean=class org.springframework.boot.web.servlet.filter.OrderedCharacterEncodingFilter
2022-05-06 03:32:14.296  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=orderRepositoryV3 bean=class hello.proxy.app.v3.OrderRepositoryV3
2022-05-06 03:32:14.304  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : create proxy: target=class hello.proxy.app.v3.OrderRepositoryV3 proxy=class hello.proxy.app.v3.OrderRepositoryV3$$EnhancerBySpringCGLIB$$cb325686
2022-05-06 03:32:14.305  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=orderServiceV3 bean=class hello.proxy.app.v3.OrderServiceV3
2022-05-06 03:32:14.307  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : create proxy: target=class hello.proxy.app.v3.OrderServiceV3 proxy=class hello.proxy.app.v3.OrderServiceV3$$EnhancerBySpringCGLIB$$26007bc3
2022-05-06 03:32:14.308  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=orderControllerV3 bean=class hello.proxy.app.v3.OrderControllerV3
2022-05-06 03:32:14.309  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : create proxy: target=class hello.proxy.app.v3.OrderControllerV3 proxy=class hello.proxy.app.v3.OrderControllerV3$$EnhancerBySpringCGLIB$$cd397d3c
2022-05-06 03:32:14.310  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=hello.proxy.config.AppV1Config bean=class hello.proxy.config.AppV1Config$$EnhancerBySpringCGLIB$$a95f75da
2022-05-06 03:32:14.312  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=orderRepositoryV1 bean=class hello.proxy.app.v1.OrderRepositoryV1Impl
2022-05-06 03:32:14.313  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : create proxy: target=class hello.proxy.app.v1.OrderRepositoryV1Impl proxy=class com.sun.proxy.$Proxy50
2022-05-06 03:32:14.313  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=orderServiceV1 bean=class hello.proxy.app.v1.OrderServiceV1Impl
2022-05-06 03:32:14.314  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : create proxy: target=class hello.proxy.app.v1.OrderServiceV1Impl proxy=class com.sun.proxy.$Proxy51
2022-05-06 03:32:14.314  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=orderControllerV1 bean=class hello.proxy.app.v1.OrderControllerV1Impl
2022-05-06 03:32:14.315  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : create proxy: target=class hello.proxy.app.v1.OrderControllerV1Impl proxy=class com.sun.proxy.$Proxy52
2022-05-06 03:32:14.315  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=hello.proxy.config.AppV2Config bean=class hello.proxy.config.AppV2Config$$EnhancerBySpringCGLIB$$f9a97c3b
2022-05-06 03:32:14.317  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=orderRepositoryV2 bean=class hello.proxy.app.v2.OrderRepositoryV2
2022-05-06 03:32:14.319  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : create proxy: target=class hello.proxy.app.v2.OrderRepositoryV2 proxy=class hello.proxy.app.v2.OrderRepositoryV2$$EnhancerBySpringCGLIB$$bd510800
2022-05-06 03:32:14.319  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=orderServiceV2 bean=class hello.proxy.app.v2.OrderServiceV2
2022-05-06 03:32:14.321  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : create proxy: target=class hello.proxy.app.v2.OrderServiceV2 proxy=class hello.proxy.app.v2.OrderServiceV2$$EnhancerBySpringCGLIB$$11a13623
2022-05-06 03:32:14.321  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=orderControllerV2 bean=class hello.proxy.app.v2.OrderControllerV2
2022-05-06 03:32:14.323  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : create proxy: target=class hello.proxy.app.v2.OrderControllerV2 proxy=class hello.proxy.app.v2.OrderControllerV2$$EnhancerBySpringCGLIB$$bf582eb6
2022-05-06 03:32:14.323  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.AutoConfigurationPackages bean=class org.springframework.boot.autoconfigure.AutoConfigurationPackages$BasePackages
2022-05-06 03:32:14.323  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.context.PropertyPlaceholderAutoConfiguration bean=class org.springframework.boot.autoconfigure.context.PropertyPlaceholderAutoConfiguration
2022-05-06 03:32:14.323  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.websocket.servlet.WebSocketServletAutoConfiguration bean=class org.springframework.boot.autoconfigure.websocket.servlet.WebSocketServletAutoConfiguration
2022-05-06 03:32:14.324  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.context.properties.EnableConfigurationPropertiesRegistrar.methodValidationExcludeFilter bean=class org.springframework.boot.validation.beanvalidation.MethodValidationExcludeFilter$$Lambda$583/0x0000000800425040
2022-05-06 03:32:14.324  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.web.servlet.DispatcherServletAutoConfiguration bean=class org.springframework.boot.autoconfigure.web.servlet.DispatcherServletAutoConfiguration
2022-05-06 03:32:14.325  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.task.TaskExecutionAutoConfiguration bean=class org.springframework.boot.autoconfigure.task.TaskExecutionAutoConfiguration
2022-05-06 03:32:14.326  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=spring.task.execution-org.springframework.boot.autoconfigure.task.TaskExecutionProperties bean=class org.springframework.boot.autoconfigure.task.TaskExecutionProperties
2022-05-06 03:32:14.327  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=taskExecutorBuilder bean=class org.springframework.boot.task.TaskExecutorBuilder
2022-05-06 03:32:14.328  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.web.servlet.error.ErrorMvcAutoConfiguration$WhitelabelErrorViewConfiguration bean=class org.springframework.boot.autoconfigure.web.servlet.error.ErrorMvcAutoConfiguration$WhitelabelErrorViewConfiguration
2022-05-06 03:32:14.328  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=error bean=class org.springframework.boot.autoconfigure.web.servlet.error.ErrorMvcAutoConfiguration$StaticView
2022-05-06 03:32:14.328  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=beanNameViewResolver bean=class org.springframework.web.servlet.view.BeanNameViewResolver
2022-05-06 03:32:14.330  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=spring.resources-org.springframework.boot.autoconfigure.web.ResourceProperties bean=class org.springframework.boot.autoconfigure.web.ResourceProperties
2022-05-06 03:32:14.331  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=spring.web-org.springframework.boot.autoconfigure.web.WebProperties bean=class org.springframework.boot.autoconfigure.web.WebProperties
2022-05-06 03:32:14.332  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.web.servlet.error.ErrorMvcAutoConfiguration$DefaultErrorViewResolverConfiguration bean=class org.springframework.boot.autoconfigure.web.servlet.error.ErrorMvcAutoConfiguration$DefaultErrorViewResolverConfiguration
2022-05-06 03:32:14.333  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=conventionErrorViewResolver bean=class org.springframework.boot.autoconfigure.web.servlet.error.DefaultErrorViewResolver
2022-05-06 03:32:14.334  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=errorAttributes bean=class org.springframework.boot.web.servlet.error.DefaultErrorAttributes
2022-05-06 03:32:14.336  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=basicErrorController bean=class org.springframework.boot.autoconfigure.web.servlet.error.BasicErrorController
2022-05-06 03:32:14.343  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration$WebMvcAutoConfigurationAdapter bean=class org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration$WebMvcAutoConfigurationAdapter
2022-05-06 03:32:14.343  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration$EnableWebMvcConfiguration bean=class org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration$EnableWebMvcConfiguration
2022-05-06 03:32:14.347  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=mvcContentNegotiationManager bean=class org.springframework.web.accept.ContentNegotiationManager
2022-05-06 03:32:14.349  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=mvcConversionService bean=class org.springframework.boot.autoconfigure.web.format.WebConversionService
2022-05-06 03:32:14.349  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=mvcValidator bean=class org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport$NoOpValidator
2022-05-06 03:32:14.355  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.http.HttpMessageConvertersAutoConfiguration bean=class org.springframework.boot.autoconfigure.http.HttpMessageConvertersAutoConfiguration
2022-05-06 03:32:14.357  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.http.HttpMessageConvertersAutoConfiguration$StringHttpMessageConverterConfiguration bean=class org.springframework.boot.autoconfigure.http.HttpMessageConvertersAutoConfiguration$StringHttpMessageConverterConfiguration
2022-05-06 03:32:14.360  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=stringHttpMessageConverter bean=class org.springframework.http.converter.StringHttpMessageConverter
2022-05-06 03:32:14.360  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.http.JacksonHttpMessageConvertersConfiguration$MappingJackson2HttpMessageConverterConfiguration bean=class org.springframework.boot.autoconfigure.http.JacksonHttpMessageConvertersConfiguration$MappingJackson2HttpMessageConverterConfiguration
2022-05-06 03:32:14.360  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.jackson.JacksonAutoConfiguration$JacksonObjectMapperConfiguration bean=class org.springframework.boot.autoconfigure.jackson.JacksonAutoConfiguration$JacksonObjectMapperConfiguration
2022-05-06 03:32:14.361  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.jackson.JacksonAutoConfiguration$JacksonObjectMapperBuilderConfiguration bean=class org.springframework.boot.autoconfigure.jackson.JacksonAutoConfiguration$JacksonObjectMapperBuilderConfiguration
2022-05-06 03:32:14.361  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.jackson.JacksonAutoConfiguration$Jackson2ObjectMapperBuilderCustomizerConfiguration bean=class org.springframework.boot.autoconfigure.jackson.JacksonAutoConfiguration$Jackson2ObjectMapperBuilderCustomizerConfiguration
2022-05-06 03:32:14.363  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=spring.jackson-org.springframework.boot.autoconfigure.jackson.JacksonProperties bean=class org.springframework.boot.autoconfigure.jackson.JacksonProperties
2022-05-06 03:32:14.364  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=standardJacksonObjectMapperBuilderCustomizer bean=class org.springframework.boot.autoconfigure.jackson.JacksonAutoConfiguration$Jackson2ObjectMapperBuilderCustomizerConfiguration$StandardJackson2ObjectMapperBuilderCustomizer
2022-05-06 03:32:14.365  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.jackson.JacksonAutoConfiguration$ParameterNamesModuleConfiguration bean=class org.springframework.boot.autoconfigure.jackson.JacksonAutoConfiguration$ParameterNamesModuleConfiguration
2022-05-06 03:32:14.367  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=parameterNamesModule bean=class com.fasterxml.jackson.module.paramnames.ParameterNamesModule
2022-05-06 03:32:14.367  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.jackson.JacksonAutoConfiguration bean=class org.springframework.boot.autoconfigure.jackson.JacksonAutoConfiguration
2022-05-06 03:32:14.371  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=jsonComponentModule bean=class org.springframework.boot.jackson.JsonComponentModule
2022-05-06 03:32:14.372  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=jacksonObjectMapperBuilder bean=class org.springframework.http.converter.json.Jackson2ObjectMapperBuilder
2022-05-06 03:32:14.384  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=jacksonObjectMapper bean=class com.fasterxml.jackson.databind.ObjectMapper
2022-05-06 03:32:14.384  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=mappingJackson2HttpMessageConverter bean=class org.springframework.http.converter.json.MappingJackson2HttpMessageConverter
2022-05-06 03:32:14.386  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=messageConverters bean=class org.springframework.boot.autoconfigure.http.HttpMessageConverters
2022-05-06 03:32:14.391  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=applicationTaskExecutor bean=class org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor
2022-05-06 03:32:14.408  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=requestMappingHandlerAdapter bean=class org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter
2022-05-06 03:32:14.410  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=mvcResourceUrlProvider bean=class org.springframework.web.servlet.resource.ResourceUrlProvider
2022-05-06 03:32:14.431  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=requestMappingHandlerMapping bean=class org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping
2022-05-06 03:32:14.434  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=welcomePageHandlerMapping bean=class org.springframework.boot.autoconfigure.web.servlet.WelcomePageHandlerMapping
2022-05-06 03:32:14.435  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=localeResolver bean=class org.springframework.web.servlet.i18n.AcceptHeaderLocaleResolver
2022-05-06 03:32:14.435  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=themeResolver bean=class org.springframework.web.servlet.theme.FixedThemeResolver
2022-05-06 03:32:14.436  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=flashMapManager bean=class org.springframework.web.servlet.support.SessionFlashMapManager
2022-05-06 03:32:14.437  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=mvcPatternParser bean=class org.springframework.web.util.pattern.PathPatternParser
2022-05-06 03:32:14.437  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=mvcUrlPathHelper bean=class org.springframework.web.util.UrlPathHelper
2022-05-06 03:32:14.437  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=mvcPathMatcher bean=class org.springframework.util.AntPathMatcher
2022-05-06 03:32:14.438  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=viewControllerHandlerMapping bean=class org.springframework.beans.factory.support.NullBean
2022-05-06 03:32:14.439  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=beanNameHandlerMapping bean=class org.springframework.web.servlet.handler.BeanNameUrlHandlerMapping
2022-05-06 03:32:14.441  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=routerFunctionMapping bean=class org.springframework.web.servlet.function.support.RouterFunctionMapping
2022-05-06 03:32:14.447  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=resourceHandlerMapping bean=class org.springframework.web.servlet.handler.SimpleUrlHandlerMapping
2022-05-06 03:32:14.447  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=defaultServletHandlerMapping bean=class org.springframework.beans.factory.support.NullBean
2022-05-06 03:32:14.447  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=handlerFunctionAdapter bean=class org.springframework.web.servlet.function.support.HandlerFunctionAdapter
2022-05-06 03:32:14.449  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=mvcUriComponentsContributor bean=class org.springframework.web.method.support.CompositeUriComponentsContributor
2022-05-06 03:32:14.449  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=httpRequestHandlerAdapter bean=class org.springframework.web.servlet.mvc.HttpRequestHandlerAdapter
2022-05-06 03:32:14.449  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=simpleControllerHandlerAdapter bean=class org.springframework.web.servlet.mvc.SimpleControllerHandlerAdapter
2022-05-06 03:32:14.452  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=handlerExceptionResolver bean=class org.springframework.web.servlet.handler.HandlerExceptionResolverComposite
2022-05-06 03:32:14.453  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=mvcViewResolver bean=class org.springframework.web.servlet.view.ViewResolverComposite
2022-05-06 03:32:14.453  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=viewNameTranslator bean=class org.springframework.web.servlet.view.DefaultRequestToViewNameTranslator
2022-05-06 03:32:14.456  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=defaultViewResolver bean=class org.springframework.web.servlet.view.InternalResourceViewResolver
2022-05-06 03:32:14.457  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=viewResolver bean=class org.springframework.web.servlet.view.ContentNegotiatingViewResolver
2022-05-06 03:32:14.458  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.jmx.JmxAutoConfiguration bean=class org.springframework.boot.autoconfigure.jmx.JmxAutoConfiguration
2022-05-06 03:32:14.459  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=objectNamingStrategy bean=class org.springframework.boot.autoconfigure.jmx.ParentAwareNamingStrategy
2022-05-06 03:32:14.462  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=mbeanServer bean=class com.sun.jmx.mbeanserver.JmxMBeanServer
2022-05-06 03:32:14.464  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=mbeanExporter bean=class org.springframework.jmx.export.annotation.AnnotationMBeanExporter
2022-05-06 03:32:14.464  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration bean=class org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration
2022-05-06 03:32:14.466  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=springApplicationAdminRegistrar bean=class org.springframework.boot.admin.SpringApplicationAdminMXBeanRegistrar
2022-05-06 03:32:14.466  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.aop.AopAutoConfiguration$ClassProxyingConfiguration bean=class org.springframework.boot.autoconfigure.aop.AopAutoConfiguration$ClassProxyingConfiguration
2022-05-06 03:32:14.466  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.aop.AopAutoConfiguration bean=class org.springframework.boot.autoconfigure.aop.AopAutoConfiguration
2022-05-06 03:32:14.466  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.availability.ApplicationAvailabilityAutoConfiguration bean=class org.springframework.boot.autoconfigure.availability.ApplicationAvailabilityAutoConfiguration
2022-05-06 03:32:14.467  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=applicationAvailability bean=class org.springframework.boot.availability.ApplicationAvailabilityBean
2022-05-06 03:32:14.467  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.context.ConfigurationPropertiesAutoConfiguration bean=class org.springframework.boot.autoconfigure.context.ConfigurationPropertiesAutoConfiguration
2022-05-06 03:32:14.468  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.context.LifecycleAutoConfiguration bean=class org.springframework.boot.autoconfigure.context.LifecycleAutoConfiguration
2022-05-06 03:32:14.468  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=spring.lifecycle-org.springframework.boot.autoconfigure.context.LifecycleProperties bean=class org.springframework.boot.autoconfigure.context.LifecycleProperties
2022-05-06 03:32:14.469  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=lifecycleProcessor bean=class org.springframework.context.support.DefaultLifecycleProcessor
2022-05-06 03:32:14.469  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.http.JacksonHttpMessageConvertersConfiguration bean=class org.springframework.boot.autoconfigure.http.JacksonHttpMessageConvertersConfiguration
2022-05-06 03:32:14.471  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=spring.info-org.springframework.boot.autoconfigure.info.ProjectInfoProperties bean=class org.springframework.boot.autoconfigure.info.ProjectInfoProperties
2022-05-06 03:32:14.471  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.info.ProjectInfoAutoConfiguration bean=class org.springframework.boot.autoconfigure.info.ProjectInfoAutoConfiguration
2022-05-06 03:32:14.471  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.sql.init.SqlInitializationAutoConfiguration bean=class org.springframework.boot.autoconfigure.sql.init.SqlInitializationAutoConfiguration
2022-05-06 03:32:14.472  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=spring.sql.init-org.springframework.boot.autoconfigure.sql.init.SqlInitializationProperties bean=class org.springframework.boot.autoconfigure.sql.init.SqlInitializationProperties
2022-05-06 03:32:14.473  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.task.TaskSchedulingAutoConfiguration bean=class org.springframework.boot.autoconfigure.task.TaskSchedulingAutoConfiguration
2022-05-06 03:32:14.473  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=scheduledBeanLazyInitializationExcludeFilter bean=class org.springframework.boot.autoconfigure.task.ScheduledBeanLazyInitializationExcludeFilter
2022-05-06 03:32:14.474  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=spring.task.scheduling-org.springframework.boot.autoconfigure.task.TaskSchedulingProperties bean=class org.springframework.boot.autoconfigure.task.TaskSchedulingProperties
2022-05-06 03:32:14.475  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=taskSchedulerBuilder bean=class org.springframework.boot.task.TaskSchedulerBuilder
2022-05-06 03:32:14.475  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.web.client.RestTemplateAutoConfiguration bean=class org.springframework.boot.autoconfigure.web.client.RestTemplateAutoConfiguration
2022-05-06 03:32:14.475  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=org.springframework.boot.autoconfigure.web.embedded.EmbeddedWebServerFactoryCustomizerAutoConfiguration bean=class org.springframework.boot.autoconfigure.web.embedded.EmbeddedWebServerFactoryCustomizerAutoConfiguration
2022-05-06 03:32:14.476  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : param beanName=multipartResolver bean=class org.springframework.web.multipart.support.StandardServletMultipartResolver
2022-05-06 03:32:14.498  INFO 91669 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8080 (http) with context path ''
2022-05-06 03:32:14.506  INFO 91669 --- [           main] hello.proxy.ProxyApplication             : Started ProxyApplication in 1.084 seconds (JVM running for 1.459)
2022-05-06 03:32:25.254  INFO 91669 --- [nio-8080-exec-1] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring DispatcherServlet 'dispatcherServlet'
2022-05-06 03:32:25.254  INFO 91669 --- [nio-8080-exec-1] o.s.web.servlet.DispatcherServlet        : Initializing Servlet 'dispatcherServlet'
2022-05-06 03:32:25.255  INFO 91669 --- [nio-8080-exec-1] o.s.web.servlet.DispatcherServlet        : Completed initialization in 1 ms
2022-05-06 03:32:25.272  INFO 91669 --- [nio-8080-exec-1] h.p.trace.logtrace.ThreadLocalLogTrace   : [597d4419] OrderControllerV1.request()
2022-05-06 03:32:25.272  INFO 91669 --- [nio-8080-exec-1] h.p.trace.logtrace.ThreadLocalLogTrace   : [597d4419] |-->OrderServiceV1.orderItem()
2022-05-06 03:32:25.272  INFO 91669 --- [nio-8080-exec-1] h.p.trace.logtrace.ThreadLocalLogTrace   : [597d4419] |   |-->OrderRepositoryV1.save()
2022-05-06 03:32:26.277  INFO 91669 --- [nio-8080-exec-1] h.p.trace.logtrace.ThreadLocalLogTrace   : [597d4419] |   |<--OrderRepositoryV1.save() time=1005ms
2022-05-06 03:32:26.277  INFO 91669 --- [nio-8080-exec-1] h.p.trace.logtrace.ThreadLocalLogTrace   : [597d4419] |<--OrderServiceV1.orderItem() time=1005ms
2022-05-06 03:32:26.277  INFO 91669 --- [nio-8080-exec-1] h.p.trace.logtrace.ThreadLocalLogTrace   : [597d4419] OrderControllerV1.request() time=1005ms
2022-05-06 03:32:29.790  INFO 91669 --- [nio-8080-exec-2] h.p.trace.logtrace.ThreadLocalLogTrace   : [a2728602] OrderControllerV2.request()
2022-05-06 03:32:29.793  INFO 91669 --- [nio-8080-exec-2] h.p.trace.logtrace.ThreadLocalLogTrace   : [a2728602] |-->OrderServiceV2.orderItem()
2022-05-06 03:32:29.795  INFO 91669 --- [nio-8080-exec-2] h.p.trace.logtrace.ThreadLocalLogTrace   : [a2728602] |   |-->OrderRepositoryV2.save()
2022-05-06 03:32:30.799  INFO 91669 --- [nio-8080-exec-2] h.p.trace.logtrace.ThreadLocalLogTrace   : [a2728602] |   |<--OrderRepositoryV2.save() time=1004ms
2022-05-06 03:32:30.800  INFO 91669 --- [nio-8080-exec-2] h.p.trace.logtrace.ThreadLocalLogTrace   : [a2728602] |<--OrderServiceV2.orderItem() time=1007ms
2022-05-06 03:32:30.800  INFO 91669 --- [nio-8080-exec-2] h.p.trace.logtrace.ThreadLocalLogTrace   : [a2728602] OrderControllerV2.request() time=1010ms
2022-05-06 03:32:33.167  INFO 91669 --- [nio-8080-exec-3] h.p.trace.logtrace.ThreadLocalLogTrace   : [e688cda2] OrderControllerV3.request()
2022-05-06 03:32:33.169  INFO 91669 --- [nio-8080-exec-3] h.p.trace.logtrace.ThreadLocalLogTrace   : [e688cda2] |-->OrderServiceV3.orderItem()
2022-05-06 03:32:33.170  INFO 91669 --- [nio-8080-exec-3] h.p.trace.logtrace.ThreadLocalLogTrace   : [e688cda2] |   |-->OrderRepositoryV3.save()
2022-05-06 03:32:34.175  INFO 91669 --- [nio-8080-exec-3] h.p.trace.logtrace.ThreadLocalLogTrace   : [e688cda2] |   |<--OrderRepositoryV3.save() time=1005ms
2022-05-06 03:32:34.175  INFO 91669 --- [nio-8080-exec-3] h.p.trace.logtrace.ThreadLocalLogTrace   : [e688cda2] |<--OrderServiceV3.orderItem() time=1006ms
2022-05-06 03:32:34.175  INFO 91669 --- [nio-8080-exec-3] h.p.trace.logtrace.ThreadLocalLogTrace   : [e688cda2] OrderControllerV3.request() time=1008ms
```

- 실행해보면 스프링 부트가 기본으로 등록하는 수 많은 빈들이 빈 후처리기를 통과하는 것을 알 수 있다. 여기에 모두 프록시를 적용하는 것은 올바르지 않다. 꼭 필요한 곳에만 프록시를 적용해야한다. 여기서는 `basePackage`를 사용해서 v1, v2, v3 애플리케이션 관련 빈들만 프록시 적용 대상이 되도록 했다.
- 그 중 proxy로 선택된 것들은 다음과 같다.

```log
2022-05-06 03:32:14.304  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : create proxy: target=class hello.proxy.app.v3.OrderRepositoryV3 proxy=class hello.proxy.app.v3.OrderRepositoryV3$$EnhancerBySpringCGLIB$$cb325686
2022-05-06 03:32:14.307  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : create proxy: target=class hello.proxy.app.v3.OrderServiceV3 proxy=class hello.proxy.app.v3.OrderServiceV3$$EnhancerBySpringCGLIB$$26007bc3
2022-05-06 03:32:14.309  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : create proxy: target=class hello.proxy.app.v3.OrderControllerV3 proxy=class hello.proxy.app.v3.OrderControllerV3$$EnhancerBySpringCGLIB$$cd397d3c
2022-05-06 03:32:14.313  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : create proxy: target=class hello.proxy.app.v1.OrderRepositoryV1Impl proxy=class com.sun.proxy.$Proxy50
2022-05-06 03:32:14.314  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : create proxy: target=class hello.proxy.app.v1.OrderServiceV1Impl proxy=class com.sun.proxy.$Proxy51
2022-05-06 03:32:14.315  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : create proxy: target=class hello.proxy.app.v1.OrderControllerV1Impl proxy=class com.sun.proxy.$Proxy52
2022-05-06 03:32:14.319  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : create proxy: target=class hello.proxy.app.v2.OrderRepositoryV2 proxy=class hello.proxy.app.v2.OrderRepositoryV2$$EnhancerBySpringCGLIB$$bd510800
2022-05-06 03:32:14.321  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : create proxy: target=class hello.proxy.app.v2.OrderServiceV2 proxy=class hello.proxy.app.v2.OrderServiceV2$$EnhancerBySpringCGLIB$$11a13623
2022-05-06 03:32:14.323  INFO 91669 --- [           main] h.p.c.v.p.PackageLogTracePostProcessor   : create proxy: target=class hello.proxy.app.v2.OrderControllerV2 proxy=class hello.proxy.app.v2.OrderControllerV2$$EnhancerBySpringCGLIB$$bf582eb6
```

- 잘 살펴보면, 인터페이스 기반(v1)은 JDK 동적 프록시로, 구체 클래스만 있는 것(v2, v3)은 CGLIB 프록시로 생성되었음을 확인할 수 있다.
- 물론 프록시 중에서도, 내부 요청에 대해 pointCut에 true인 대상들만 advice가 적용된다.
- `PackageLogTracePostProcessor`
  - 원본 객체를 프록시 객체로 변환하는 역할을 한다.
  - 이 때 프록시 팩토리를 사용하는데, 프록시 팩토리는 `advisor`가 필요하기 때문에 이 부분은 외부에서 주입받도록 했다.
  - 모든 스프링 빈들에 프록시를 적용할 필요는 없다. 여기서는 특정 패키지와 그 하위에 위치한 스프링 빈들만 프록시를 적용한다.
  - 여기서는 `hello.proxy.app`과 관련된 부분에만 적용하면 된다. 다른 패키지의 객체들은 원본 객체를 그대로 반환한다.
  - 프록시 적용 대상의 반환 값을 보면, 원본 객체 대신에 프록시 객체를 반환한다.
  - 따라서 스프링 컨테이너에 원본 객체 대신에 프록시 객체가 스프링 빈으로 등록된다. 원본 객체는 스프링 빈으로 등록되지 않는다.
- `@Import({ AppV1Config.class, AppV2Config.class })`
  - 이 부분을 application main에서 해도 상관없다.
  - V3는 컴포넌트 스캔으로 자동으로 스프링 빈으로 등록되지만, V1, V2 애플리케이션은 수동으로 스프링 빈으로 등록해야 동작한다.
- `@Bean logTraceProxyPostProcessor()`
  - 특정 패키지를 기준으로 프록시를 생성하는 빈 후처리기를 스프링 빈으로 등록한다.
  - **빈 후처리기는 스프링 빈으로만 등록하면 자동으로 동작한다.**
  - 여기에 프록시를 적용할 패키지 정보(`hello.proxy.app`)와 어드바이저(`getAdvisor(logTrace)`)를 넘겨준다.
  - **이제 프록시를 생성하는 코드가 설정파일에는 필요없다.** (프록시를 생성하기 위해 ProxyFactory에서 advisor를 넘겨주고 다시 Bean으로 등록하고.. 실체 클래스는 다시 연관된 프록시 객체를 DI 받고 등등..)
    - 순수한 빈 등록만 고민하면 된다.
    - 프록시를 생성하고 프록시를 스프링 빈으로 등록하는 것은 빈 후처리기가 모두 처리해준다.

**컴포넌트 스캔에도 적용**

- 여기서 중요한 포인트는 v1, v2와 같이 수동으로 등록한 빈 뿐만 아니라, 컴포넌트 스캔을 통해 등록한 v3 빈들도 프록시를 적용할 수 있다는 점이다.
- 이것은 모두 빈 후처리기 덕분이다.

**프록시 적용 대상 여부 체크**

- 애플리케이션을 실행해서 로그를 확인해보면 알겠지만, 우리가 직접 등록한 스프링 빈들 뿐만 아니라 스프링 부트가 기본으로 등록하는 수 많은 빈들이 빈 후처리기에 넘어온다.
- 그래서 어떤 빈을 프록시로 만들 것인지 기준이 필요하다.
- 여기서는 간단히 `basePackage`를 사용해서 특정 패키지를 기준으로 해당 패키지와 그 하위 패키지의 빈들을 프록시로 만든다.
- 스프링 부트가 기본으로 제공하는 빈 중에서는 프록시 객체를 만들 수 없는 빈들도 있다. 따라서 모든 객체를 프록시로 만들 경우 오류가 발생한다.
## 빈 후처리기 - 정리

> 다시 한 번 문제점을 짚어보자.

**1. 지나치게 많은 설정**
- 문제였던 프록시 생성을 위해 `@Configuration`에 했던 ProxyFactory 관련 설정이 지나치게 많다는 문제가 있었다.
- 예를 들어 100개의 빈이 있으면 부가 기능을 위해 100개의 프록시 설정 코드가 들어가야했다.
- 무수히 많은 설정 파일 때문에 설정 지옥을 경험하게 될 것이다.

**2. 컴포넌트 스캔**
- 컴포넌트 스캔으로 이미 스프링 컨테이너에 실제 객체를 스프링 빈으로 등록을 다 해버린 상태여서 기존에 배웠던 방식으로는 프록시 적용이 불가능했다.
- v1, v2에서 한 것 처럼 빈을 수동등록 하면서 proxy로 갈아끼웠기 때문이다.
- 그런데 컴포넌트 스캔은 원본 객체를 스프링 빈으로 자동 등록하기 때문에 프록시 적용이 불가능하다.

> 문제 해결

- 빈 후처리기 덕분에 프록시를 생성하는 부분을 하나로 집중할 수 있다.
- 그리고 컴포넌트 스캔처럼 스프링이 직접 대상을 빈으로 등록하는 경우에도 중간에 빈 등록 과정을 가로채서 원본 대신에 프록시를 스프링 빈으로 등록할 수 있다.
- 덕분에 애플리케이션에 수 많은 스프링 빈이 추가되어도 프록시와 관련된 코드는 전혀 변경하지 않아도 된다.
- 그리고 컴포넌트 스캔을 사용해도 모두 프록시가 적용된다.

**하지만 개발자의 욕심은 끝이 없다.**
- 스프링은 프록시를 생성하기 위한 빈 후처리기를 이미 만들어서 제공한다.

> #### 중요

- 프록시의 적용 대상 여부를 여기서는 간단히 패키지를 기준으로 설정했다.
- 그런데 잘 생각해보면 포인트컷을 사용하면 더 깔끔할 것 같다.
- 포인트컷은 이미 클래스, 메서드 단위의 필터 기능을 갖고 있기 때문에 프록시 적용 대상 여부를 정밀하게 설정할 수 있다.
- 참고로 어드바이저는 포인트 컷을 가지고 있다. 따라서 어드바이저를 통해 포인트컷을 확인할 수 있다.
- 뒤에서 학습하겠지만, 스프링 AOP는 포인트컷을 사용해서 프록시 적용 대상 여부를 체크한다.

**결과적으로 포인트 컷은 다음 두 곳에서 사용한다.**
1. 프록시 적용 대상 여부를 체크해서 꼭 필요한 곳에만 프록시를 적용한다.(빈 후처리기 - 자동 프록시 생성)
2. 프록시의 어떤 메서드가 호출되었을 때 어드바이스를 적용할 지 판단한다.(프록시 내부)

## 스프링이 제공하는 빈 후처리기 1

- 다음을 꼭 추가해주자.

```groovy
implementation 'org.springframework.boot:spring-boot-starter-aop'
```

- 위 라이브러리를 추가하면 `aspectjweaver` 라는 `aspectJ` 관련 라이브러리를 등록하고, 스프링 부트가 AOP 관련 클래스를 자동으로 스프링 빈에 등록한다.
- 스프링 부트가 없던 시절에는 `@EnableAspectJAutoProxy`를 직접 사용해야 했는데, 이 부분을 스프링 부트가 자동으로 처리해준다.
- `aspectJ`는 뒤에서 설명한다. 스프링 부트가 활성화하는 빈은 `AutoConfiguration`를 참고하자

**자동 프록시 생성기 - AutoProxyCreator**

- 위의 라이브러리를 추가하면, 앞서 이야기한 스프링 부트 자동 설정으로 `AnnotationAwareAspectJAutoProxyCreator`라는 빈 후처리기가 스프링 빈에 자동으로 등록된다.
- 이름 그대로 **자동으로 프록시를 생성해주는 빈 후처리기**이다.
- **이 빈 후처리기는 스프링 빈으로 등록된 `Advisor` 들을 자동으로 찾아서 프록시가 필요한 곳에 자동으로 프록시를 적용**해준다.
- `Advisor` 안에는 `Pointcut`과 `Advice`가 이미 모두 포함되어 있다.
- 따라서 **`Advisor`만 알고 있으면, 그 안에 있는 `Pointcut`으로 어떤 스프링 빈에 프록시를 적용해야 할 지 알 수 있다. 그리고 `Advice`로 부가 기능을 적용하면 된다.**

![](/images/2022-05-06-04-06-15.png)

> 참고

- `AnnotationAwareAspectJAutoProxyCreator` 는 `@AspectJ`와 관련된 AOP 기능도 자동으로 찾아서 처리해준다.
- `Advisor`는 물론이고, `@Aspect`도 자동으로 인식해서 프록시를 만들고 AOP를 적용해준다.

> **자동 프록시 생성기의 작동 과정**

![](/images/2022-05-06-04-07-06.png)

1. **생성**: 스프링이 스프링 빈 대상이 되는 객체를 생성한다(`@Bean`, 컴포넌트 스캔 모두 포함)
2. **전달**: 생성된 객체를 빈 저장소에 등록하기 **직전에** 빈 후처리기에 전달한다.
3. **모든 Advisor 빈 조회**: 자동 프록시 생성기 - 빈 후처리기는 스프링 컨테이너에서 모든 `Advisor`를 조회한다.
4. **프록시 적용 대상 체크**
   - 앞서 조회한 `Advisor`에 포함되어 있는 포인트컷을 사용해서 해당 객체가 프록시를 적용할 대상인지 아닌지 판단한다.
   - 이때 객체의 클래스 정보는 물론이고, 해당 객체의 모든 메서드를 포인트컷 하나하나 모두 매칭해본다.
   - 그래서 조건이 하나라도 만족하면 프록시 적용 대상이 된다.
   - 예를 들어, 10개의 메서드 중 하나만 포인트 컷 조건에 만족해도 프록시 적용 대상이 된다.
5. **프록시 생성**: 프록시 적용 대상이면 프록시를 생성하고 반환해서 프록시를 스프링 빈으로 등록한다. 만약 프록시 적용 대상이 아니라면 원본 객체를 반환해서 원본 객체를 스프링 빈으로 등록한다.
6. **빈 등록**: 반환된 객체는 스프링 빈으로 등록된다.

![](/images/2022-05-06-04-11-55.png)

- 프록시는 내부에 어드바이저와 실제 호출해야할 대상 객체(target)을 알고 있다.

> 코드로 적용해보기

```java
@Configuration
@Import({ AppV1Config.class, AppV2Config.class })
public class AutoProxyConfig {

    /**
     * 자동 프록시 생성기가 이미 스프링에 자동으로 등록이 되어있으니, 그 BeanPostProcssor이 어드바이저를 찾는다고 했다.
     * 따라서 어드바이저만 등록해주면 끝이다.
     */
    @Bean
    public Advisor getAdvisor1(final LogTrace logTrace) {
        // pointcut
        final NameMatchMethodPointcut pointcut = new NameMatchMethodPointcut();
        pointcut.setMappedNames("request*", "order*", "save*");

        // advice
        final LogTraceAdvice advice = new LogTraceAdvice(logTrace);

        return new DefaultPointcutAdvisor(pointcut, advice);
    }
}
```

```java
@Import(AutoProxyConfig.class)
@SpringBootApplication(scanBasePackages = "hello.proxy.app") //주의
public class ProxyApplication {

	public static void main(String[] args) {
		SpringApplication.run(ProxyApplication.class, args);
	}

	@Bean
	public LogTrace logTrace(){
		return new ThreadLocalLogTrace();
	}
}
```

**중요: 포인트 컷은 2가지에 사용된다.**

1. **프록시 적용 여부 판단**
    - 자동 프록시 생성기는 포인트컷을 사용해서 해당 빈이 프록시를 생성할 필요가 있는지 없는지 체크한다.
    - 클래스 + 메서드 조건을 모두 비교한다.
    - 이때 모든 메서드를 체크하는데, 포인트컷 조건에 하나하나 매칭해본다.
    - 만약 조건에 맞는 것이 하나라도 있으면 프록시를 생성한다.
      - 예) `orderControllerV1`은 `request()`, `noLog()`가 있다. 여기에서 `request()`가 조건에 만족하므로 프록시를 생성한다.
    - 만약 조건에 맞는 것이 하나도 없으면 프록시를 생성할 필요가 없으므로 프록시를 생성하지 않는다.
2. **어드바이스 적용 여부 판단 - 사용 단계**
    - 프록시가 호출되었을 때 부가 기능인 어드바이스를 적용할지 말지 포인트컷을 보고 판단한다.
    - 앞서 설명한 예에서 `orderControllerV1`은 이미 프록시가 걸려있다.
    - `orderControllerV1`의 `request()`는 현재 포인트컷 조건에 만족하므로 프록시는 어드바이스를 먼저 호출하고, `target`을 호출한다.
    - `orderControllerV1`의 `noLog()`는 현재 포인트컷 조건에 만족하지 않으므로 어드바이스를 호출하지 않고 바로 `target`만 호출한다.

> **참고**

- 프록시를 모든 곳에 생성하는 것은 비용 낭비이다.
- 꼭 필요한 곳에 최소한의 프록시를 적용해야 한다.
- 그래서 자동 프록시 생성기는 모든 스프링 빈에 프록시를 적용하는 것이 아니라, 포인트컷으로 한 번 필터링해서 어드바이스가 사용될 가능성이 있는 곳에만 프록시를 생성한다.
## 스프링이 제공하는 빈 후처리기 2

- 위에 실행시킨 애플리케이션 로딩 로그를 잠깐 확인해보자

```log
2022-05-06 04:15:55.150  INFO 742 --- [           main] h.p.trace.logtrace.ThreadLocalLogTrace   : [bd1cb9be] AppV1Config.orderControllerV1()
2022-05-06 04:15:55.156  INFO 742 --- [           main] h.p.trace.logtrace.ThreadLocalLogTrace   : [bd1cb9be] |-->AppV1Config.orderServiceV1()
2022-05-06 04:15:55.156  INFO 742 --- [           main] h.p.trace.logtrace.ThreadLocalLogTrace   : [bd1cb9be] |   |-->AppV1Config.orderRepositoryV1()
2022-05-06 04:15:55.156  INFO 742 --- [           main] h.p.trace.logtrace.ThreadLocalLogTrace   : [bd1cb9be] |   |<--AppV1Config.orderRepositoryV1() time=0ms
2022-05-06 04:15:55.158  INFO 742 --- [           main] h.p.trace.logtrace.ThreadLocalLogTrace   : [bd1cb9be] |<--AppV1Config.orderServiceV1() time=3ms
2022-05-06 04:15:55.160  INFO 742 --- [           main] h.p.trace.logtrace.ThreadLocalLogTrace   : [bd1cb9be] AppV1Config.orderControllerV1() time=10ms
2022-05-06 04:15:55.164  INFO 742 --- [           main] h.p.trace.logtrace.ThreadLocalLogTrace   : [ac84392b] AppV2Config.orderControllerV2()
2022-05-06 04:15:55.167  INFO 742 --- [           main] h.p.trace.logtrace.ThreadLocalLogTrace   : [ac84392b] |-->AppV2Config.orderServiceV2()
2022-05-06 04:15:55.167  INFO 742 --- [           main] h.p.trace.logtrace.ThreadLocalLogTrace   : [ac84392b] |   |-->AppV2Config.orderRepositoryV2()
2022-05-06 04:15:55.167  INFO 742 --- [           main] h.p.trace.logtrace.ThreadLocalLogTrace   : [ac84392b] |   |<--AppV2Config.orderRepositoryV2() time=0ms
2022-05-06 04:15:55.169  INFO 742 --- [           main] h.p.trace.logtrace.ThreadLocalLogTrace   : [ac84392b] |<--AppV2Config.orderServiceV2() time=2ms
2022-05-06 04:15:55.171  INFO 742 --- [           main] h.p.trace.logtrace.ThreadLocalLogTrace   : [ac84392b] AppV2Config.orderControllerV2() time=7ms
2022-05-06 04:15:55.217  INFO 742 --- [           main] h.p.trace.logtrace.ThreadLocalLogTrace   : [ea01a48f] EnableWebMvcConfiguration.requestMappingHandlerAdapter()
2022-05-06 04:15:55.255  INFO 742 --- [           main] h.p.trace.logtrace.ThreadLocalLogTrace   : [ea01a48f] EnableWebMvcConfiguration.requestMappingHandlerAdapter() time=38ms
2022-05-06 04:15:55.275  INFO 742 --- [           main] h.p.trace.logtrace.ThreadLocalLogTrace   : [0e05d8cb] EnableWebMvcConfiguration.requestMappingHandlerMapping()
2022-05-06 04:15:55.279  INFO 742 --- [           main] h.p.trace.logtrace.ThreadLocalLogTrace   : [0e05d8cb] EnableWebMvcConfiguration.requestMappingHandlerMapping() time=4ms
```

- method에 `request*`나, `order*`와 같은 것들이 포함된 다른 기대하지 않은 빈들도 프록시가 되었다.
- 그 이유는 지금 사용한 포인트 컷이 단순히 메서드 이름에 `request*, order*, save*`만 포함되어 있으면 매칭된다고 판단하기 때문이다.
- 결국 스프링 내부에서 사용하는 빈에도 메서드 이름에 `request`라는 단어만 있으면 프록시가 만들어지고, 어드바이스도 적용되는 것이다.
- 결론적으로 패키지에 메서드 이름까지 함께 지정할 수 있는 **매우 정밀한 포인트 컷이 필요**하다.

**AspectJExpressionPointcut**

- AspectJ라는 AOP에 특화된 포인트컷 표현식을 적용할 수 있다.
- AspectJ 포인트컷 표현식과 AOP는 조금 뒤에 자세히 설명한다.
- 지금은 특별한 표현식으로 복잡한 포인트컷을 만들 수 있구나.. 정도 대략 이해하고 넘어가자.

> AutoProxyConfig - advisor2 추가

```java
@Bean
public Advisor advisor2(final LogTrace logTrace) {
    // pointcut
    final AspectJExpressionPointcut pointcut = new AspectJExpressionPointcut();
    pointcut.setExpression("execution(* hello.proxy.app..*(..))");

    // advice
    final LogTraceAdvice advice = new LogTraceAdvice(logTrace);

    return new DefaultPointcutAdvisor(pointcut, advice);
}
```

*주의: advisor1에 있는 @Bean은 주석처리해주자. 어드바이저가 중복 등록된다.*

- `AspectJExpressionPointcut` : AspectJ 포인트컷 표현식을 적용할 수 있다.
- `execution(* hello.proxy.app..*(..))`: AspectJ가 제공하는 포인트컷 표현식이다. 이후 자세히 설명한다. 지금은 간단히 확인해보자.
  - `*`: 모든 반환 타입
  - `hello.proxy.app..`: 해당 패키지와 그 하위 패키지
  - `*(..)`: `*`는 모든 메서드 이름, `(..)`는 파라미터는 상관없음의 의미이다.
- 쉽게 이야기해서 `hello.proxy.app` 패키지와 그 하위 패키지 모든 메서드는 포인트컷 매칭 대상이 된다.

실행 결과는 다음과 같다. 이제는 그 전처럼 스프링 등록시에 다른 패키지들은 등록되지 않는 것을 확인할 수 있다. `hello.proxy.app` 패키지 내부에 있는 것들이 프록시 대상이 된다.
```log
2022-05-06 04:54:57.444  INFO 8386 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 8080 (http)
2022-05-06 04:54:57.450  INFO 8386 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]
2022-05-06 04:54:57.451  INFO 8386 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat/9.0.53]
2022-05-06 04:54:57.492  INFO 8386 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext
2022-05-06 04:54:57.492  INFO 8386 --- [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 654 ms
2022-05-06 04:54:57.802  INFO 8386 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8080 (http) with context path ''
2022-05-06 04:54:57.809  INFO 8386 --- [           main] hello.proxy.ProxyApplication             : Started ProxyApplication in 1.234 seconds (JVM running for 1.819)
2022-05-06 04:55:04.709  INFO 8386 --- [nio-8080-exec-1] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring DispatcherServlet 'dispatcherServlet'
2022-05-06 04:55:04.709  INFO 8386 --- [nio-8080-exec-1] o.s.web.servlet.DispatcherServlet        : Initializing Servlet 'dispatcherServlet'
2022-05-06 04:55:04.710  INFO 8386 --- [nio-8080-exec-1] o.s.web.servlet.DispatcherServlet        : Completed initialization in 1 ms
2022-05-06 04:55:04.727  INFO 8386 --- [nio-8080-exec-1] h.p.trace.logtrace.ThreadLocalLogTrace   : [e3aede88] OrderControllerV1Impl.request()
2022-05-06 04:55:04.731  INFO 8386 --- [nio-8080-exec-1] h.p.trace.logtrace.ThreadLocalLogTrace   : [e3aede88] |-->OrderServiceV1Impl.orderItem()
2022-05-06 04:55:04.733  INFO 8386 --- [nio-8080-exec-1] h.p.trace.logtrace.ThreadLocalLogTrace   : [e3aede88] |   |-->OrderRepositoryV1Impl.save()
2022-05-06 04:55:05.738  INFO 8386 --- [nio-8080-exec-1] h.p.trace.logtrace.ThreadLocalLogTrace   : [e3aede88] |   |<--OrderRepositoryV1Impl.save() time=1005ms
2022-05-06 04:55:05.738  INFO 8386 --- [nio-8080-exec-1] h.p.trace.logtrace.ThreadLocalLogTrace   : [e3aede88] |<--OrderServiceV1Impl.orderItem() time=1007ms
2022-05-06 04:55:05.738  INFO 8386 --- [nio-8080-exec-1] h.p.trace.logtrace.ThreadLocalLogTrace   : [e3aede88] OrderControllerV1Impl.request() time=1011ms
2022-05-06 04:55:09.585  INFO 8386 --- [nio-8080-exec-2] h.p.trace.logtrace.ThreadLocalLogTrace   : [1ae1ae46] OrderControllerV2.request()
2022-05-06 04:55:09.587  INFO 8386 --- [nio-8080-exec-2] h.p.trace.logtrace.ThreadLocalLogTrace   : [1ae1ae46] |-->OrderServiceV2.orderItem()
2022-05-06 04:55:09.589  INFO 8386 --- [nio-8080-exec-2] h.p.trace.logtrace.ThreadLocalLogTrace   : [1ae1ae46] |   |-->OrderRepositoryV2.save()
2022-05-06 04:55:10.591  INFO 8386 --- [nio-8080-exec-2] h.p.trace.logtrace.ThreadLocalLogTrace   : [1ae1ae46] |   |<--OrderRepositoryV2.save() time=1002ms
2022-05-06 04:55:10.592  INFO 8386 --- [nio-8080-exec-2] h.p.trace.logtrace.ThreadLocalLogTrace   : [1ae1ae46] |<--OrderServiceV2.orderItem() time=1005ms
2022-05-06 04:55:10.592  INFO 8386 --- [nio-8080-exec-2] h.p.trace.logtrace.ThreadLocalLogTrace   : [1ae1ae46] OrderControllerV2.request() time=1007ms
2022-05-06 04:55:13.546  INFO 8386 --- [nio-8080-exec-3] h.p.trace.logtrace.ThreadLocalLogTrace   : [0bdd8487] OrderControllerV3.request()
2022-05-06 04:55:13.548  INFO 8386 --- [nio-8080-exec-3] h.p.trace.logtrace.ThreadLocalLogTrace   : [0bdd8487] |-->OrderServiceV3.orderItem()
2022-05-06 04:55:13.549  INFO 8386 --- [nio-8080-exec-3] h.p.trace.logtrace.ThreadLocalLogTrace   : [0bdd8487] |   |-->OrderRepositoryV3.save()
2022-05-06 04:55:14.556  INFO 8386 --- [nio-8080-exec-3] h.p.trace.logtrace.ThreadLocalLogTrace   : [0bdd8487] |   |<--OrderRepositoryV3.save() time=1007ms
2022-05-06 04:55:14.556  INFO 8386 --- [nio-8080-exec-3] h.p.trace.logtrace.ThreadLocalLogTrace   : [0bdd8487] |<--OrderServiceV3.orderItem() time=1008ms
2022-05-06 04:55:14.556  INFO 8386 --- [nio-8080-exec-3] h.p.trace.logtrace.ThreadLocalLogTrace   : [0bdd8487] OrderControllerV3.request() time=1010ms
```

그러나 아직 문제가 있다.

no-log를 요청했을 때도 로그가 나오고 있다.
```
http://localhost:8080/v3/no-log
```

```log
2022-05-06 04:59:02.099  INFO 8386 --- [nio-8080-exec-6] h.p.trace.logtrace.ThreadLocalLogTrace   : [207e5acd] OrderControllerV3.noLog()
2022-05-06 04:59:02.099  INFO 8386 --- [nio-8080-exec-6] h.p.trace.logtrace.ThreadLocalLogTrace   : [207e5acd] OrderControllerV3.noLog() time=0ms
```

- Advisor를 다음과 같이 수정해보자.

```java
@Bean
public Advisor advisor2(final LogTrace logTrace) {
    // pointcut
    final AspectJExpressionPointcut pointcut = new AspectJExpressionPointcut();
    pointcut.setExpression("execution(* hello.proxy.app..*(..)) && !execution(* hello.proxy.app..noLog(..)");

    // advice
    final LogTraceAdvice advice = new LogTraceAdvice(logTrace);

    return new DefaultPointcutAdvisor(pointcut, advice);
}
```

- 다시 실행해보면 `/no-log` 요청에 대해 로그가 남지 않음을 확인할 수 있다.
- 표현식을 다음과 같이 수정했다.

```java
"execution(* hello.proxy.app..*(..)) && !execution(* hello.proxy.app..noLog(..)"
```

- `hello.proxy.app` 패키지와 하위 패키지의 모든 메서드는 포인트컷 매칭하되, `noLog()`메서드는 제외하라는 뜻이다.
  - `&&`: 두 조건을 모두 만족해야함
  - `!`: 반대
  - `||`: 또는


## 하나의 프록시, 여러 Advisor 적용

- 예를 들어, 어떤 스프링 빈이 `advisor1`, `advisor2`가 제공하는 포인트컷 조건을 모두 만족하면 프록시 자동 생성기는 프록시를 몇 개 생성할까?
  - **프록시 자동 생성기는 프록시를 하나만 생성한다.**
  - 왜냐하면 프록시 팩토리가 생성하는 프록시는 내부에 여러 `advisor`들을 포함할 수 있기 때문이다.
  - 따라서 프록시를 여러개 생성해서 비용을 낭비할 이유가 없다.

**프록시 자동 생성기 상황별 정리**

- `advisor1`의 포인트컷만 만족 -> 프록시 1개 생성, 프록시에 `advisor1`만 포함
- `advisor1`, `advisor2`의 포인트컷 모두 만족 -> 프록시 1개 생성, 프록시에 `advisor1`, `advisor2` 모두 포함(프록시 하나에 어드바이저 여러개 포함)
- `advisor1`, `advisor2`의 포인트 컷을 모두 만족하지 않음 -> 프록시가 생성되지 않음

***스프링 AOP도 동일한 방식으로 동작한다.***

![](/images/2022-05-06-05-08-45.png)
![](/images/2022-05-06-05-08-57.png)


## 정리

- 자동 프록시 생성기인 `AnnotationAwareAspectJAutoProxyCreator` 덕분에 개발자는 매우 편리하게 프록시를 적용할 수 있다.
- `Advisor`= `Pointcut` + `Advice`
- 다음번에 `@Aspect` 애노테이션을 사용하여 더 편리하게 포인트컷과 어드바이스를 만들고 프록시를 적용해보자.